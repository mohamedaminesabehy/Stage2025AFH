<div class="article-analytics" *ngIf="data">
  
  <!-- Métriques principales -->
  <div class="metrics-summary">
    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-header">
          <mat-icon>inventory</mat-icon>
          <span class="metric-title">Total Articles</span>
        </div>
        <div class="metric-value">{{formatNumber(data.total)}}</div>
        <div class="metric-subtitle">Référencés</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-header">
          <mat-icon>category</mat-icon>
          <span class="metric-title">Catégories</span>
        </div>
        <div class="metric-value">{{data.categories?.length || 0}}</div>
        <div class="metric-subtitle">Différentes</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-header">
          <mat-icon>trending_up</mat-icon>
          <span class="metric-title">Plus Utilisé</span>
        </div>
        <div class="metric-value">{{data.plusUtilises?.[0]?.utilisations || 0}}</div>
        <div class="metric-subtitle">Utilisations</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Graphiques -->
  <div class="charts-section">
    
    <!-- Évolution des prix -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>timeline</mat-icon>
          Évolution des Prix
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
                  [data]="chartData.evolutionPrix"
                  [options]="chartOptions"
                  type="line">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Répartition par secteur -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>pie_chart</mat-icon>
          Répartition par Secteur
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
                  [data]="chartData.repartitionSecteur"
                  [options]="chartOptions"
                  type="doughnut">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Articles populaires -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>star</mat-icon>
          Articles les Plus Utilisés
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
                  [data]="chartData.articlesPopulaires"
                  [options]="chartOptions"
                  type="bar">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Répartition TVA -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>receipt</mat-icon>
          Répartition TVA
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
                  [data]="chartData.repartitionTVA"
                  [options]="chartOptions"
                  type="bar">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

  <!-- Tableaux détaillés -->
  <div class="tables-section">
    
    <!-- Articles populaires -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>star</mat-icon>
          Articles les Plus Utilisés
        </mat-card-title>
        <div class="card-actions">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Rechercher</mat-label>
            <input matInput (keyup)="applyFilter($event, articlesPopulairesDataSource)" placeholder="Nom de l'article">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
          <button mat-icon-button (click)="exportArticleData()" matTooltip="Exporter">
            <mat-icon>download</mat-icon>
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="articlesPopulairesDataSource" class="articles-table">
            
            <!-- Colonne Désignation -->
            <ng-container matColumnDef="designation">
              <th mat-header-cell *matHeaderCellDef>Article</th>
              <td mat-cell *matCellDef="let article">
                <div class="article-info">
                  <div class="article-name">{{article.designation}}</div>
                  <div class="article-number">{{article.numArticle}}</div>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Utilisations -->
            <ng-container matColumnDef="utilisations">
              <th mat-header-cell *matHeaderCellDef>Utilisations</th>
              <td mat-cell *matCellDef="let article">
                <div class="usage-info">
                  <span class="usage-count">{{article.utilisations}}</span>
                  <mat-chip class="usage-level" [ngClass]="getUsageLevelColor(article.utilisations)">
                    {{getUsageLevel(article.utilisations)}}
                  </mat-chip>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Montant Total -->
            <ng-container matColumnDef="montantTotal">
              <th mat-header-cell *matHeaderCellDef>Montant Total</th>
              <td mat-cell *matCellDef="let article">
                <div class="montant-total">
                  {{formatCurrency(article.montantTotal)}}
                </div>
              </td>
            </ng-container>

            <!-- Colonne Prix Moyen -->
            <ng-container matColumnDef="prixMoyen">
              <th mat-header-cell *matHeaderCellDef>Prix Moyen</th>
              <td mat-cell *matCellDef="let article">
                <div class="prix-moyen">
                  {{formatCurrency(article.prixMoyen)}}
                </div>
              </td>
            </ng-container>

            <!-- Colonne Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let article">
                <button mat-icon-button 
                        (click)="viewArticleDetails(article)"
                        matTooltip="Voir détails">
                  <mat-icon>visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="articlesPopulairesColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: articlesPopulairesColumns;"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

</div>
