<div class="fournisseur-analytics" *ngIf="data">
  
  <!-- Métriques principales -->
  <div class="metrics-summary">
    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-header">
          <mat-icon>business</mat-icon>
          <span class="metric-title">Total Fournisseurs</span>
        </div>
        <div class="metric-value">{{data.total | number}}</div>
        <div class="metric-subtitle">{{data.actifs}} actifs</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-header">
          <mat-icon>add_business</mat-icon>
          <span class="metric-title">Nouveaux Fournisseurs</span>
        </div>
        <div class="metric-value">{{data.nouveaux | number}}</div>
        <div class="metric-subtitle">Ce mois</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-header">
          <mat-icon>star</mat-icon>
          <span class="metric-title">Score Performance</span>
        </div>
        <div class="metric-value">{{data.scorePerformance | number:'1.1-1'}}</div>
        <div class="metric-subtitle">Moyenne globale</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Graphiques -->
  <div class="charts-section">
    
    <!-- Évolution mensuelle -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>timeline</mat-icon>
          Évolution Mensuelle
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
                  [data]="chartData.evolution"
                  [options]="chartOptions"
                  type="line">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Performance des top fournisseurs -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>bar_chart</mat-icon>
          Performance Top 10
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
                  [data]="chartData.performance"
                  [options]="chartOptions"
                  type="bar">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Répartition par montant -->
    <mat-card class="chart-card full-width">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>monetization_on</mat-icon>
          Répartition des Montants par Région
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
                  [data]="chartData.montants"
                  [options]="chartOptions"
                  type="bar">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

  <!-- Tableaux détaillés -->
  <div class="tables-section">
    
    <!-- Top Fournisseurs -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>emoji_events</mat-icon>
          Top Fournisseurs
        </mat-card-title>
        <div class="card-actions">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Rechercher</mat-label>
            <input matInput (keyup)="applyFilter($event, topFournisseursDataSource)" placeholder="Nom du fournisseur">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
          <button mat-icon-button (click)="exportFournisseurData()" matTooltip="Exporter">
            <mat-icon>download</mat-icon>
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="topFournisseursDataSource" class="fournisseurs-table">
            
            <!-- Colonne Désignation -->
            <ng-container matColumnDef="designation">
              <th mat-header-cell *matHeaderCellDef>Fournisseur</th>
              <td mat-cell *matCellDef="let fournisseur">
                <div class="fournisseur-info">
                  <div class="fournisseur-name">{{fournisseur.designation}}</div>
                  <div class="fournisseur-name-fr">{{fournisseur.designationFr}}</div>
                  <div class="fournisseur-details">
                    <span class="matricule">{{fournisseur.matriculeFisc}}</span>
                    <span class="adresse">{{fournisseur.adresse}}</span>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Nombre de Marchés -->
            <ng-container matColumnDef="nombreMarches">
              <th mat-header-cell *matHeaderCellDef>Marchés</th>
              <td mat-cell *matCellDef="let fournisseur">
                <div class="marches-count">
                  <mat-icon>assignment</mat-icon>
                  {{fournisseur.nombreMarches}}
                </div>
              </td>
            </ng-container>

            <!-- Colonne Montant Total -->
            <ng-container matColumnDef="montantTotal">
              <th mat-header-cell *matHeaderCellDef>Montant Total</th>
              <td mat-cell *matCellDef="let fournisseur">
                <div class="montant-total">
                  {{formatCurrency(fournisseur.montantTotal)}}
                </div>
              </td>
            </ng-container>

            <!-- Colonne Score Performance -->
            <ng-container matColumnDef="scorePerformance">
              <th mat-header-cell *matHeaderCellDef>Performance</th>
              <td mat-cell *matCellDef="let fournisseur">
                <div class="performance-score">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="fournisseur.scorePerformance"
                    [color]="getPerformanceColor(fournisseur.scorePerformance)">
                  </mat-progress-bar>
                  <span class="score-value" [ngClass]="getPerformanceColor(fournisseur.scorePerformance)">
                    {{fournisseur.scorePerformance | number:'1.1-1'}}%
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let fournisseur">
                <button mat-icon-button 
                        (click)="viewFournisseurDetails(fournisseur)"
                        matTooltip="Voir détails">
                  <mat-icon>visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="topFournisseursColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: topFournisseursColumns;"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Répartition par Région -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>location_on</mat-icon>
          Répartition par Région
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="repartitionDataSource" class="repartition-table">
            
            <!-- Colonne Région -->
            <ng-container matColumnDef="region">
              <th mat-header-cell *matHeaderCellDef>Région</th>
              <td mat-cell *matCellDef="let region">
                <div class="region-name">
                  <mat-icon>place</mat-icon>
                  {{region.region}}
                </div>
              </td>
            </ng-container>

            <!-- Colonne Nombre -->
            <ng-container matColumnDef="nombre">
              <th mat-header-cell *matHeaderCellDef>Nombre</th>
              <td mat-cell *matCellDef="let region">
                <div class="nombre-fournisseurs">
                  {{region.nombre | number}}
                </div>
              </td>
            </ng-container>

            <!-- Colonne Pourcentage -->
            <ng-container matColumnDef="pourcentage">
              <th mat-header-cell *matHeaderCellDef>Pourcentage</th>
              <td mat-cell *matCellDef="let region">
                <div class="pourcentage-region">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="region.pourcentage"
                    color="primary">
                  </mat-progress-bar>
                  <span class="percentage-value">{{formatPercentage(region.pourcentage)}}</span>
                </div>
              </td>
            </ng-container>

            <!-- Colonne Montant Total -->
            <ng-container matColumnDef="montantTotal">
              <th mat-header-cell *matHeaderCellDef>Montant Total</th>
              <td mat-cell *matCellDef="let region">
                <div class="montant-region">
                  {{formatCurrency(region.montantTotal)}}
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="repartitionColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: repartitionColumns;"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

</div>
